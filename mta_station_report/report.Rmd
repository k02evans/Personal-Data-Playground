---
title: "MTA Subway Stations Analysis"
author: "Data Analysis Report"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

## Introduction

This report analyzes the MTA Subway Stations dataset to answer key questions about station distribution, naming patterns, directional labels, and geographic characteristics across New York City's five boroughs.

![New York City Subway Transit Map](Screenshots/TRANSIT%20MAP.png)

```{r load-data}
# Load the MTA Subway Stations data
stations <- read.csv("data/MTA_Subway_Stations_20240916.csv", stringsAsFactors = FALSE)

# Display basic information about the dataset
cat("Total number of stations:", nrow(stations_data), "\n")
cat("Number of unique stations:", length(unique(stations_data$Station.ID)), "\n")
```

## Analysis

### Question 1: Which borough has the most stations?

```{r borough-analysis}
# Create frequency table for stations by borough
borough_freq <- table(stations_data$Borough)

# Create a formatted data frame
borough_df <- data.frame(
  Borough = names(borough_freq),
  Count = as.numeric(borough_freq)
)

# Map borough codes to full names
borough_names <- c("Bk" = "Brooklyn", "Bx" = "Bronx", "M" = "Manhattan", 
                   "Q" = "Queens", "SI" = "Staten Island")
borough_df$BoroughName <- borough_names[borough_df$Borough]

# Sort by count (descending)
borough_df <- borough_df[order(borough_df$Count, decreasing = TRUE), ]

# Find the borough with the most stations
most_stations <- borough_df[1, ]
```

**Answer:** `r most_stations$BoroughName` has the most stations with **`r most_stations$Count`** stations.

```{r borough-table, echo=FALSE}
# Display the frequency table
knitr::kable(borough_df[, c("BoroughName", "Count")], 
             col.names = c("Borough", "Number of Stations"),
             align = "lc")
```

```{r borough-plot, echo=FALSE, fig.cap="Number of MTA Subway Stations by Borough"}
# Create bar chart
par(mar = c(5, 5, 4, 2) + 0.1)
bar_positions <- barplot(borough_df$Count, 
                         names.arg = borough_df$BoroughName,
                         main = "Number of MTA Subway Stations by Borough",
                         xlab = "Borough",
                         ylab = "Number of Stations",
                         col = "steelblue",
                         border = "darkblue",
                         las = 1,
                         cex.names = 0.9,
                         cex.axis = 0.9,
                         cex.main = 1.2)

# Add value labels on top of bars
text(x = bar_positions, 
     y = borough_df$Count + 5,
     labels = borough_df$Count,
     cex = 0.9,
     font = 2)
```

### Question 2: How many stops include a number, and how many don't?

```{r number-analysis}
# Check if stop names contain numbers
# Using regex to detect any digit in the stop name
has_number <- grepl("[0-9]", stations$Stop.Name)
stops_with_numbers <- sum(has_number)
stops_without_numbers <- sum(!has_number)

# Calculate percentages
total_stops <- nrow(stations)
pct_with <- round((stops_with_numbers / total_stops) * 100, 1)
pct_without <- round((stops_without_numbers / total_stops) * 100, 1)
```

**Answer:** 
- **`r stops_with_numbers`** stops (`r pct_with`%) include a number in their name
- **`r stops_without_numbers`** stops (`r pct_without`%) do not include a number

```{r number-table, echo=FALSE}
number_summary <- data.frame(
  Category = c("Stops with Numbers", "Stops without Numbers"),
  Count = c(stops_with_numbers, stops_without_numbers),
  Percentage = c(pct_with, pct_without)
)
knitr::kable(number_summary, align = "lcc")
```

### Question 3: What is the most common North Direction Label and most common South Direction Label?

```{r direction-analysis}
# Analyze North Direction Labels
north_labels <- table(stations$North.Direction.Label, useNA = "ifany")
north_labels_sorted <- sort(north_labels, decreasing = TRUE)
most_common_north <- names(north_labels_sorted)[1]
north_count <- as.numeric(north_labels_sorted[1])

# Analyze South Direction Labels
south_labels <- table(stations$South.Direction.Label, useNA = "ifany")
south_labels_sorted <- sort(south_labels, decreasing = TRUE)
most_common_south <- names(south_labels_sorted)[1]
south_count <- as.numeric(south_labels_sorted[1])
```

**Answer:**
- **Most common North Direction Label:** `r most_common_north` (appears `r north_count` times)
- **Most common South Direction Label:** `r most_common_south` (appears `r south_count` times)

```{r direction-tables, echo=FALSE}
# Display top 5 for each direction
cat("Top 5 North Direction Labels:\n")
north_top5 <- head(north_labels_sorted, 5)
north_df <- data.frame(
  Label = names(north_top5),
  Count = as.numeric(north_top5)
)
knitr::kable(north_df, row.names = FALSE, align = "lc")

cat("\n\nTop 5 South Direction Labels:\n")
south_top5 <- head(south_labels_sorted, 5)
south_df <- data.frame(
  Label = names(south_top5),
  Count = as.numeric(south_top5)
)
knitr::kable(south_df, row.names = FALSE, align = "lc")
```

### Question 4: What is the average latitude of Bronx stops vs Staten Island stops?

```{r latitude-comparison}
# Filter stations by borough
bronx_stations <- stations[stations$Borough == "Bx", ]
si_stations <- stations[stations$Borough == "SI", ]
brooklyn_stations <- stations[stations$Borough == "Bk", ]
manhattan_stations <- stations[stations$Borough == "M", ]
queens_stations <- stations[stations$Borough == "Q", ]

# Calculate average latitude for all boroughs
avg_lat_bronx <- mean(bronx_stations$GTFS.Latitude, na.rm = TRUE)
avg_lat_si <- mean(si_stations$GTFS.Latitude, na.rm = TRUE)
avg_lat_brooklyn <- mean(brooklyn_stations$GTFS.Latitude, na.rm = TRUE)
avg_lat_manhattan <- mean(manhattan_stations$GTFS.Latitude, na.rm = TRUE)
avg_lat_queens <- mean(queens_stations$GTFS.Latitude, na.rm = TRUE)

# Calculate difference between Bronx and Staten Island
lat_diff <- avg_lat_bronx - avg_lat_si
```

**Answer:**
- **Average latitude of Bronx stops:** `r round(avg_lat_bronx, 6)` degrees
- **Average latitude of Staten Island stops:** `r round(avg_lat_si, 6)` degrees
- **Difference:** `r round(lat_diff, 6)` degrees (Bronx is `r ifelse(lat_diff > 0, "north", "south")` of Staten Island)

```{r latitude-table, echo=FALSE}
latitude_comparison <- data.frame(
  Borough = c("Bronx", "Staten Island"),
  Average_Latitude = c(round(avg_lat_bronx, 6), round(avg_lat_si, 6)),
  Number_of_Stations = c(nrow(bronx_stations), nrow(si_stations))
)
knitr::kable(latitude_comparison, align = "lcc", 
             col.names = c("Borough", "Average Latitude", "Number of Stations"))
```

```{r latitude-plot, echo=FALSE, fig.cap="Latitude Distribution: All Boroughs"}
# Organize borough data into a list for easier sorting
borough_data <- list(
  "Bronx" = list(stations = bronx_stations, avg_lat = avg_lat_bronx),
  "Staten Island" = list(stations = si_stations, avg_lat = avg_lat_si),
  "Brooklyn" = list(stations = brooklyn_stations, avg_lat = avg_lat_brooklyn),
  "Manhattan" = list(stations = manhattan_stations, avg_lat = avg_lat_manhattan),
  "Queens" = list(stations = queens_stations, avg_lat = avg_lat_queens)
)

# Sort boroughs by average latitude (lowest to highest)
sorted_boroughs <- names(borough_data)[order(sapply(borough_data, function(x) x$avg_lat))]

# Define color scheme for all boroughs
# Grey-scale colors (desaturated versions)
grey_colors <- c(
  "Bronx" = "#8FA3C4",         # Grey-scale blue
  "Staten Island" = "#C9A961", # Grey-scale orange
  "Brooklyn" = "#9AB89A",      # Grey-scale green
  "Manhattan" = "#B8A8C4",     # Grey-scale purple
  "Queens" = "#C4A8A8"         # Grey-scale red
)

# High saturation colors
saturated_colors <- c(
  "Bronx" = "#0066FF",         # High saturation blue
  "Staten Island" = "#FF6600", # High saturation orange
  "Brooklyn" = "#00AA00",      # High saturation green
  "Manhattan" = "#9900CC",     # High saturation purple
  "Queens" = "#CC0000"         # High saturation red
)

# Prepare data for scatter plot
# Create y positions with jitter for better visibility
set.seed(123)  # For reproducible jitter
y_positions <- list()
for (i in 1:5) {
  borough_name <- sorted_boroughs[i]
  n_stations <- nrow(borough_data[[borough_name]]$stations)
  y_positions[[borough_name]] <- i + runif(n_stations, -0.12, 0.12)
}

# Set up plot parameters with extra right margin for legend
par(mar = c(5, 6, 4, 8) + 0.1, xpd = TRUE)

# Determine latitude range for x-axis (all boroughs)
all_latitudes <- unlist(lapply(borough_data, function(x) x$stations$GTFS.Latitude))
lat_range <- range(all_latitudes, na.rm = TRUE)
lat_min <- floor(lat_range[1] * 20) / 20  # Round down to nearest 0.05
lat_max <- ceiling(lat_range[2] * 20) / 20  # Round up to nearest 0.05

# Create empty plot
plot(1, type = "n",
     xlim = c(lat_min, lat_max),
     ylim = c(0.5, 5.5),
     xlab = "Latitude (degrees)",
     ylab = "",
     main = "Latitude Distribution: All Boroughs (Sorted by Average Latitude)",
     xaxt = "n",
     yaxt = "n",
     cex.main = 1.2,
     cex.lab = 1.0)

# Set x-axis with 0.05 intervals
x_breaks <- seq(lat_min, lat_max, by = 0.05)
axis(1, at = x_breaks, labels = round(x_breaks, 2), cex.axis = 0.8, las = 1)

# Set y-axis labels (sorted order)
axis(2, at = 1:5, labels = sorted_boroughs, 
     las = 1, cex.axis = 1.0, tick = FALSE)

# Plot individual stations for all boroughs (in sorted order)
for (i in 1:5) {
  borough_name <- sorted_boroughs[i]
  stations_data <- borough_data[[borough_name]]$stations
  y_pos <- y_positions[[borough_name]]
  
  points(stations_data$GTFS.Latitude, y_pos,
         col = adjustcolor(grey_colors[borough_name], alpha.f = 0.6),
         pch = 19, cex = 0.7)
}

# Add average lines and points with high saturation colors (in sorted order)
# Set xpd = FALSE temporarily to clip lines to plot area
par(xpd = FALSE)
for (i in 1:5) {
  borough_name <- sorted_boroughs[i]
  avg_lat <- borough_data[[borough_name]]$avg_lat
  
  # Use segments to draw lines only within plot boundaries
  segments(x0 = avg_lat, y0 = 0.5, x1 = avg_lat, y1 = 5.5, 
           col = saturated_colors[borough_name], lwd = 2, lty = 2)
  points(avg_lat, i, 
         col = saturated_colors[borough_name],
         pch = 19,
         cex = 2.5)
}
# Set xpd = TRUE again for legend placement
par(xpd = TRUE)

# Add legend outside plot area (in sorted order to match plot)
legend_stations <- paste0(sorted_boroughs, " Stations")
legend_averages <- paste0(sorted_boroughs, " Average")
legend(x = lat_max + 0.02, y = 5.5,
       legend = c(legend_stations, legend_averages),
       col = c(grey_colors[sorted_boroughs], saturated_colors[sorted_boroughs]),
       pch = c(rep(19, 5), rep(19, 5)),
       pt.cex = c(rep(0.7, 5), rep(2.5, 5)),
       lty = c(rep(NA, 5), rep(2, 5)),
       lwd = c(rep(NA, 5), rep(2, 5)),
       cex = 0.7,
       bg = "white",
       ncol = 1)
```

### Question 5: What is the stop with the highest and lowest latitude?

```{r extreme-latitude}
# Find stop with highest latitude
max_lat_idx <- which.max(stations$GTFS.Latitude)
highest_stop <- stations[max_lat_idx, ]
max_lat <- highest_stop$GTFS.Latitude

# Find stop with lowest latitude
min_lat_idx <- which.min(stations$GTFS.Latitude)
lowest_stop <- stations[min_lat_idx, ]
min_lat <- lowest_stop$GTFS.Latitude
```

**Answer:**
- **Stop with highest latitude:** `r highest_stop$Stop.Name` (Latitude: `r round(max_lat, 6)` degrees)
  - Borough: `r borough_names[highest_stop$Borough]`
  - Line: `r highest_stop$Line`
  
- **Stop with lowest latitude:** `r lowest_stop$Stop.Name` (Latitude: `r round(min_lat, 6)` degrees)
  - Borough: `r borough_names[lowest_stop$Borough]`
  - Line: `r lowest_stop$Line`

```{r extreme-table, echo=FALSE}
extreme_stops <- data.frame(
  Category = c("Highest Latitude", "Lowest Latitude"),
  Stop_Name = c(highest_stop$Stop.Name, lowest_stop$Stop.Name),
  Borough = c(borough_names[highest_stop$Borough], borough_names[lowest_stop$Borough]),
  Latitude = c(round(max_lat, 6), round(min_lat, 6))
)
knitr::kable(extreme_stops, align = "lccc", row.names = FALSE)
```

## Conclusion

This analysis of the MTA Subway Stations dataset reveals several key insights:

1. **Brooklyn** has the largest number of subway stations among all boroughs, with 169 stations.

2. A significant portion of station names (`r pct_with`%) include numbers, which likely reflects the street numbering system used throughout New York City.

3. Directional labels show clear patterns, with **`r most_common_north`** being the most common northbound direction and **`r most_common_south`** being the most common southbound direction.

4. Geographic analysis shows that **Bronx** stations are located at a higher average latitude than **Staten Island** stations, reflecting their relative positions in the New York City metropolitan area.

5. The northernmost station is **`r highest_stop$Stop.Name`**, while the southernmost is **`r lowest_stop$Stop.Name`**, demonstrating the extensive geographic coverage of the MTA subway system.

These findings provide valuable insights into the distribution and characteristics of New York City's subway infrastructure across its five boroughs.

